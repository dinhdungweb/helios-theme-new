{%- liquid
  if collection.url.size == 0
    assign results_url = routes.all_products_collection_url
  else
    assign results_url = collection.url
  endif

  if results_url contains "?"
    assign results_url = results_url | split: "?" | first
  endif

  assign current_sort_by = collection.sort_by | default: collection.default_sort_by
  
  # Sắp xếp các block theo vị trí
  assign promotion_blocks = section.blocks | sort: 'settings.position_in_grid'
-%}

<div data-section-type="collection-template"
     data-ajax-filtering="{{ section.settings.ajax_products }}"
     data-components="tabs,product-block,price-range,accordion,sticky-scroll-direction"
     class="pb-medium {% if section.settings.show_collection_image and collection.featured_image %}header-overlap-section{% elsif section.settings.show_collection_content %}pt-medium{% else %}sm:pt-medium{% endif %}" data-cc-animate>

  {% paginate collection.products by section.settings.products_per_page %}
    {% if section.settings.show_collection_image and collection.featured_image %}
      <div class="collection-header image-overlay image-overlay--bg-full needs-alt-logo">
        <div class="rimage-outer-wrapper rimage-background lazyload fade-in"
             data-cc-animate="cc-fade-in-zoom-out"
             data-bgset="{% render 'bgset', image: collection.featured_image %}"
             data-sizes="auto"
             data-parent-fit="cover">
          <noscript>
            <div class="rimage-wrapper" style="padding-top:{{ 1 | divided_by: collection.featured_image.aspect_ratio | times: 100 }}%">
              <img src="{{ collection.featured_image | img_url: '1024x1024' }}" 
                   alt="{{ collection.featured_image.alt | escape }}" 
                   class="rimage__image"
                   width="{{ collection.featured_image.width }}"
                   height="{{ collection.featured_image.height }}">
            </div>
          </noscript>
        </div>

        <div class="overlay-type overlay" data-cc-animate="cc-fade-in-zoom-out">
          <div class="overlay__content">
    {% endif %}

      <div class="central">
        <div class="content transparent">
          {% if section.settings.show_collection_content %}
            {% if collection.description != blank %}
              <h1 class="line-1 feature-header" data-cc-animate>{{ collection.title }}</h1>

              {% if section.settings.description_position == "top" %}
                <div class="line-2 rte" data-cc-animate data-cc-animate-delay="0.2s">
                  {{ collection.description }}
                </div>
              {% endif %}
            {% else %}
              <h1 class="line-1 feature-header no-margin" data-cc-animate>{{ collection.title }}</h1>
            {% endif %}
          {% endif %}
        </div>
      </div>

    {% if section.settings.show_collection_image and collection.featured_image %}
          </div>
        </div>
      </div>
    {% endif %}

    {% render "search-filter",
      mode: "collection",
      results: collection,
      section: section,
      results_url: results_url,
      paginate: paginate,
      current_sort_by: current_sort_by,
      promotion_blocks: promotion_blocks
    %}

    {% if collection.description != blank and section.settings.description_position == "bottom" and section.settings.show_collection_content == true %}
      <div class="central footer">
        <div class="content transparent">
          <div class="rte">
            {{ collection.description }}
          </div>
        </div>
      </div>
    {% endif %}
  {% endpaginate %}
</div>

<style>
  .promotion-block img {
    width: 100%;
    height: auto;
    display: block;
  }
  .promotion-content {
    padding: 15px;
    text-align: center;
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    color: white;
  }
  .promotion-heading {
    margin-bottom: 5px;
    font-size: 1.1rem;
    line-height: 1.7;
    text-transform: uppercase;
  }
  .promotion-link {
    display: block;
    text-decoration: none;
    color: inherit;
    position: relative;
    height: 100%;
  }
  .responsive-video-wrapper video {
    width: 100%;
    height: auto;
    display: block;
  }
  @media screen and (max-width: 768px) {
    .hide-on-mobile {
      display: none !important;
    }
    .show-on-mobile {
      display: block;
    }
  }
  @media screen and (min-width: 769px) {
    .hide-on-mobile {
      display: block;
    }
    .show-on-mobile {
      display: none !important;
    }
  }
  
  /* Reset cho tất cả khối promotion */
  .product-list .promotion-block {
    box-sizing: border-box;
    padding: 0 10px;
  }
  
  /* Cấu hình động dựa trên số sản phẩm trên một hàng */
  /* Khi grid là 2 sản phẩm trên 1 hàng */
  .product-list.grid-2 .promotion-block.one-column {
    width: 50% !important;
    max-width: 50% !important;
    display: inline-block;
    clear: none;
  }
  
  .product-list.grid-2 .promotion-block.two-columns {
    width: 100% !important;
    max-width: 100% !important;
    display: inline-block;
    clear: none;
  }
  
  /* Khi grid là 3 sản phẩm trên 1 hàng (mặc định) */
  .product-list.grid-3 .promotion-block.one-column,
  .product-list .promotion-block.one-column {
    width: 33.333% !important;
    max-width: 33.333% !important;
    display: inline-block;
    clear: none;
  }
  
  .product-list.grid-3 .promotion-block.two-columns,
  .product-list .promotion-block.two-columns {
    width: 66.666% !important;
    max-width: 66.666% !important;
    display: inline-block;
    clear: none;
  }
  
  /* Khi grid là 4 sản phẩm trên 1 hàng */
  .product-list.grid-4 .promotion-block.one-column {
    width: 25% !important;
    max-width: 25% !important;
    display: inline-block;
    clear: none;
  }
  
  .product-list.grid-4 .promotion-block.two-columns {
    width: 50% !important;
    max-width: 50% !important;
    display: inline-block;
    clear: none;
  }
  
  /* Sửa vấn đề với grid layout */
  .product-list.grid--uniform {
    display: flex;
    flex-wrap: wrap;
  }
  
  .product-list.grid--uniform .product-block {
    float: none;
  }
  
  /* Đảm bảo hiển thị đúng trên mobile */
  @media screen and (max-width: 768px) {
    .product-list .promotion-block.one-column,
    .product-list .promotion-block.two-columns,
    .product-list.grid-2 .promotion-block.one-column,
    .product-list.grid-2 .promotion-block.two-columns,
    .product-list.grid-3 .promotion-block.one-column,
    .product-list.grid-3 .promotion-block.two-columns,
    .product-list.grid-4 .promotion-block.one-column,
    .product-list.grid-4 .promotion-block.two-columns {
      width: 100% !important;
      max-width: 100% !important;
      display: block;
    }
  }
  
  /* Để đảm bảo chiều cao bằng nhau */
  .promotion-image-container, .promotion-video-container {
    height: 100%;
  }
  
  .responsive-image-wrapper {
    height: 100%;
    position: relative;
    border-radius: 3px;
    overflow: hidden;
  }
  
  .responsive-image-wrapper img {
    object-fit: cover;
    height: 100%;
    width: 100%;
  }
  
  .product-block.promotion-block {
    display: flex;
    align-items: stretch;
  }
  
  .product-block.promotion-block > div {
    width: 100%;
    display: flex;
  }
  
  .product-block.promotion-block .promotion-link {
    width: 100%;
    display: flex;
    flex-direction: column;
  }
  
  /* Đảm bảo phần ảnh chiếm toàn bộ không gian */
  .product-list .product-block {
    display: flex;
    flex-direction: column;
  }
  
  .product-list .product-block .product-block__inner {
    display: flex;
    flex-direction: column;
    flex: 1;
  }
  
  .product-list .product-block .image {
    flex: 1;
    height: 100%;
  }
  
  .product-list .product-block .image .image-inner {
    height: 100%;
  }
  
  .product-list .product-block .image .image__first {
    height: 100%;
  }
</style>


{% schema %}
  {
    "name": "Collection pages",
    "class": "theme-filter-container",
    "settings": [
      {
        "type": "header",
        "content": "Header"
      },
      {
        "type": "checkbox",
        "id": "show_collection_content",
        "label": "Show collection title/description",
        "default": true
      },
      {
        "type": "checkbox",
        "id": "show_collection_image",
        "label": "Show collection image",
        "default": true
      },
      {
        "type": "select",
        "id": "description_position",
        "label": "Description position",
        "options": [
          {
            "value": "top",
            "label": "Top"
          },
          {
            "value": "bottom",
            "label": "Bottom"
          }
        ]
      },
      {
        "type": "header",
        "content": "GRID"
      },
      {
        "type": "select",
        "id": "layout",
        "label": "Layout",
        "options": [
          {
            "value": "columns",
            "label": "Collage"
          },
          {
            "value": "rows",
            "label": "Grid"
          }
        ],
        "default": "rows",
        "info": "Collage will only work when the 'Image shape' is set to Natural - in Products / Image shape"
      },
      {
        "type": "range",
        "id": "grid",
        "label": "Desktop products per row",
        "min": 2,
        "max": 4,
        "default": 3
      },
      {
        "type": "select",
        "id": "grid_mobile",
        "label": "Mobile products per row",
        "options": [
          {
            "value": "1",
            "label": "1"
          },
          {
            "value": "2",
            "label": "2"
          }
        ],
        "default": "2"
      },
      {
        "type": "range",
        "id": "products_per_page",
        "label": "Products per page",
        "min": 6,
        "max": 48,
        "step": 6,
        "default": 18
      },
      {
        "type": "checkbox",
        "id": "featured_addtocart_hide",
        "label": "Hide Add to cart",
        "info": "Add to cart will be disabled on touch devices.",
        "default": false
      },
      {
        "type": "checkbox",
        "id": "enable_infinite_scroll",
        "label": "Enable infinite-scroll",
        "default": true,
        "info": "As visitors scroll down, more products are loaded in automatically."
      },
      {
        "type": "checkbox",
        "id": "show_vendor",
        "label": "Show product vendor",
        "default": false
      },
      {
        "type": "header",
        "content": "FILTERS"
      },
      {
        "type": "paragraph",
        "content": "To create the collection filters, go to your [navigation](\/admin\/menus) page."
      },
      {
        "type": "checkbox",
        "id": "show_filter_counts",
        "label": "Show filter counts",
        "default": false
      },
      {
        "type": "checkbox",
        "id": "show_filter_deadends",
        "label": "Show filters with zero results",
        "default": true
      },
      {
        "type": "checkbox",
        "id": "ajax_products",
        "label": "Filter and sort without reloading the page",
        "default": true,
        "info": "Some apps require this to be disabled"
      },
      {
        "type": "radio",
        "id": "filter_mode",
        "label": "Filter mode",
        "default": "sidebar",
        "options": [
          {
            "value": "none",
            "label": "None"
          },
          {
            "value": "simple",
            "label": "Simple"
          },
          {
            "value": "sidebar",
            "label": "Sidebar"
          },
          {
            "value": "drawer",
            "label": "Drawer (Desktop)"
          }
        ],
        "info": "'Simple' is only recommended if you have a small number of filters. Note, it doesn't allow for multiple options within a filter to be selected and it won't show the price range filter."
      },
      {
        "type": "header",
        "content": "Sidebar Settings"
      },
      {
        "type": "checkbox",
        "id": "sticky_sidebar",
        "label": "Stick the sidebar on scroll",
        "default": true
      },
      {
        "type": "select",
        "id": "collapse_filters_method",
        "label": "Filter group collapse",
        "default": "none",
        "options": [
          {
            "value": "none",
            "label": "None"
          },
          {
            "value": "over-6",
            "label": "Over 6 items"
          },
          {
            "value": "over-12",
            "label": "Over 12 items"
          },
          {
            "value": "over-18",
            "label": "Over 18 items"
          },
          {
            "value": "all",
            "label": "All"
          }
        ]
      },
      {
        "type": "checkbox",
        "id": "collapse_sort_by",
        "label": "Collapse 'Sort by' filter group",
        "default": false
      },
      {
        "type": "header",
        "content": "Sorting"
      },
      {
        "type": "checkbox",
        "id": "enable_sorting",
        "label": "Enable sorting",
        "default": true
      },
      {
        "type": "checkbox",
        "id": "show_featured_in_sort",
        "label": "Show 'Featured' option in sorting dropdown",
        "default": false
      }
    ],
    "blocks": [
      {
        "type": "promotion_image",
        "name": "Promotion image",
        "settings": [
          {
            "type": "range",
            "id": "position_in_grid",
            "min": 1,
            "max": 48,
            "step": 1,
            "default": 4,
            "label": "Position in grid"
          },
          {
            "type": "select",
            "id": "desktop_size",
            "label": "Desktop item size",
            "options": [
              {
                "value": "one-column",
                "label": "1 column"
              },
              {
                "value": "two-columns",
                "label": "2 columns"
              }
            ],
            "default": "one-column"
          },
          {
            "type": "image_picker",
            "id": "image",
            "label": "Image"
          },
          {
            "type": "image_picker",
            "id": "mobile_image",
            "label": "Mobile image"
          },
          {
            "type": "text",
            "id": "heading",
            "label": "Heading",
            "default": "Promote a product or a temporary offer"
          },
          {
            "type": "richtext",
            "id": "content",
            "label": "Content"
          },
          {
            "type": "url",
            "id": "link_url",
            "label": "Link URL"
          }
        ]
      },
      {
        "type": "promotion_video",
        "name": "Promotion video",
        "settings": [
          {
            "type": "range",
            "id": "position_in_grid",
            "min": 1,
            "max": 48,
            "step": 1,
            "default": 8,
            "label": "Position in grid"
          },
          {
            "type": "select",
            "id": "desktop_size",
            "label": "Desktop item size",
            "options": [
              {
                "value": "one-column",
                "label": "1 column"
              },
              {
                "value": "two-columns",
                "label": "2 columns"
              }
            ],
            "default": "one-column"
          },
          {
            "type": "video",
            "id": "video",
            "label": "Video"
          },
          {
            "type": "image_picker",
            "id": "video_poster",
            "label": "Video poster image"
          },
          {
            "type": "checkbox",
            "id": "autoplay",
            "label": "Autoplay video",
            "default": false,
            "info": "Video will be muted when autoplaying"
          },
          {
            "type": "text",
            "id": "heading",
            "label": "Heading",
            "default": "Promote a product or a temporary offer"
          },
          {
            "type": "richtext",
            "id": "content",
            "label": "Content"
          },
          {
            "type": "url",
            "id": "link_url",
            "label": "Link URL"
          }
        ]
      }
    ],
    "presets": [
      {
        "name": "Collection pages",
        "settings": {}
      }
    ]
  }
{% endschema %}
